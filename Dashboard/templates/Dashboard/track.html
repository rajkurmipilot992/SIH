{% include 'Main/base.html' %}
<script src="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css" rel="stylesheet" />
<div class="container-fluid">
    <div class="row">
        <div class="col-3 bg-light">
            <h4 class="mt-4">{{train.id}}. - {{train.train_no}} ({{train.train_from}} - {{train.train_to}})</h4>
            <h4 class="ml-5">{{train.tarin_days}}</h4>
            {%for i in stations%}
            <p class="text-right">{{i}}</p>
            {%endfor%}
            <!-- track -->
            <style>
            ul.timeline {
                list-style-type: none;
                position: relative;
            }

            ul.timeline:before {
                content: ' ';
                background: #007BFF;
                display: inline-block;
                position: absolute;
                left: 28px;
                width: 4px;
                height: 93%;
                z-index: 400;
            }

            ul.timeline:after {
                content: ' ';
                background: #FD6165;
                position: absolute;
                left: 28px;
                top: 0px;
                width: 4px;
                height: 0%;
                z-index: 400;
            }

            ul.timeline>li {
                margin: 20px 0;
                padding-left: 20px;
            }

            ul.timeline>li:before {
                content: ' ';
                background: white;
                display: inline-block;
                position: absolute;
                border-radius: 50%;
                border: 3px solid #007BFF;
                left: 20px;
                width: 20px;
                height: 20px;
                z-index: 500;
            }

            ul.timeline>.sm_li_dot:before {
                content: ' ';
                border: 2px solid #FD6165;
                left: 22px;
                width: 15px;
                height: 15px;
            }

            ul.timeline>.bg_li_dot:before {
                content: ' ';
                border: 3px solid #FD6165;
            }
            </style>
            {%for i in station%}
            <div class="containe-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="container">
                            <div class="row">
                                <div class=" mt-3 py-3 col-12">
                                    <div class="container-fluid">
                                        <div class="row">
                                            <h3 class="col-12">Status: {{trains.train_live_station}}</h3>
                                            <div class=" col-12">
                                                <ul class="timeline">
                                                    {%if i in i.status%}
                                                    <style>
                                                    ul.timeline:after {
                                                        height: 0%;
                                                    }

                                                    ul.timeline:before {
                                                        height: 93%;
                                                    }
                                                    </style>
                                                    <li class="bg_li_dot">
                                                        <p class="text-danger mb-0">Order Placed</p>
                                                        <p>{{i.placed_at}}</p><br>
                                                    </li><br><br><br><br><br><br><br><br><br><br><br><br>
                                                    <li>
                                                        <p class="mb-0 text-success">Excepted Delivery</p>
                                                        <span>{{i.excepted_delivery_at}}</span>
                                                    </li>
                                                    {%elif "Ordered" in i.status%}
                                                    <style>
                                                    ul.timeline:after {
                                                        height: 23%;
                                                    }
                                                    </style>
                                                    <li class="bg_li_dot">
                                                        <p class="text-danger mb-0">Order Placed</p>
                                                        <p>{{i.placed_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Confirmed</a>
                                                            <p>{{i.ordered_at}}</p><br>
                                                    </li>
                                                    <br><br><br><br><br><br><br><br><br>
                                                    <li>
                                                        <p class="mb-0 text-success">Excepted Delivery</p>
                                                        <span>{{i.excepted_delivery_at}}</span>
                                                    </li>
                                                    {%elif "ShippingSoon" in i.status%}
                                                    <style>
                                                    ul.timeline:after {
                                                        height: 43%;
                                                    }
                                                    </style>
                                                    <li class="bg_li_dot">
                                                        <p class="text-danger mb-0">Order Placed</p>
                                                        <p>{{i.placed_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Confirmed</a>
                                                            <p>{{i.ordered_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Shipping soon</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li>
                                                    <br><br><br><br><br><br>
                                                    <li>
                                                        <p class="mb-0 text-success">Excepted Delivery</p>
                                                        <span>{{i.excepted_delivery_at}}</span>
                                                    </li>
                                                    {%elif "Shipped" in i.status%}
                                                    <style>
                                                    ul.timeline:after {
                                                        height: 58%;
                                                    }
                                                    </style>
                                                    <li class="bg_li_dot">
                                                        <p class="text-danger mb-0">Order Placed</p>
                                                        <p>{{i.placed_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Confirmed</a>
                                                            <p>{{i.ordered_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Shipping soon</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Shipped</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li>
                                                    <br><br><br>
                                                    <li>
                                                        <p class="mb-0 text-success">Excepted Delivery</p>
                                                        <span>{{i.excepted_delivery_at}}</span>
                                                    </li>
                                                    {%elif "OutForDelivery" in i.status%}
                                                    <style>
                                                    ul.timeline:after {
                                                        height: 75%;
                                                    }
                                                    </style>
                                                    <li class="bg_li_dot">
                                                        <p class="text-danger mb-0">Order Placed</p>
                                                        <p>{{i.placed_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Confirmed</a>
                                                            <p>{{i.ordered_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Shipping soon</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Shipped</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li class="sm_li_dot">
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Out For Deliivery</a>
                                                            <p>{{i.out_for_delivery_at}}</p><br>
                                                    </li>
                                                    <li>
                                                        <p class="mb-0 text-success">Excepted Delivery</p>
                                                        <span>{{i.excepted_delivery_at}}</span>
                                                    </li>
                                                    {%elif "Delivered" in i.status%}
                                                    <style>
                                                    ul.timeline:after {
                                                        height: 93%;
                                                    }
                                                    </style>
                                                    <li class="bg_li_dot">
                                                        <p class="text-danger mb-0">Order Placed</p>
                                                        <p>{{i.placed_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Confirmed</a>
                                                            <p>{{i.ordered_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Shipping soon</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li>
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Order Shipped</a>
                                                            <p>{{i.shipping_soon_at}}</p><br>
                                                    </li class="sm_li_dot">
                                                    <li class="sm_li_dot">
                                                        <p class="text-info mb-0">Out For Deliivery</a>
                                                            <p>{{i.out_for_delivery_at}}</p><br>
                                                    </li>
                                                    <li class="bg_li_dot">
                                                        <p class="mb-0 text-success">Delivered</p>
                                                        <span>{{i.delivered_at}}</span>
                                                    </li>
                                                    {%endif%}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {%endfor%}
            <!-- end track -->
        </div>
        <div class="col-9 p-0" id='map' style='width: 100%; height: 80vh;'></div>
    </div>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoicmFqc29uaTAzIiwiYSI6ImNrNThmY25tYTA3MWwzbG50bzdndXZ5ZngifQ.-fSnHZymHAiDIUBKSuQGAQ';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: {{ center_point }},
    zoom: {{ map_zoom }}
});

var size = 150;

// implementation of CustomLayerInterface to draw a pulsing dot icon on the map
// see https://docs.mapbox.com/mapbox-gl-js/api/#customlayerinterface for more info
var pulsingDot = {
    width: size,
    height: size,
    data: new Uint8Array(size * size * 4),

    // get rendering context for the map canvas when layer is added to the map
    onAdd: function() {
        var canvas = document.createElement('canvas');
        canvas.width = this.width;
        canvas.height = this.height;
        this.context = canvas.getContext('2d');
    },

    // called once before every frame where the icon will be used
    render: function() {
        var duration = 1000;
        var t = (performance.now() % duration) / duration;

        var radius = (size / 2) * 0.3;
        var outerRadius = (size / 2) * 0.7 * t + radius;
        var context = this.context;

        // draw outer circle
        context.clearRect(0, 0, this.width, this.height);
        context.beginPath();
        context.arc(
            this.width / 2,
            this.height / 2,
            outerRadius,
            0,
            Math.PI * 2
        );
        context.fillStyle = 'rgba(255, 200, 200,' + (1 - t) + ')';
        context.fill();

        // draw inner circle
        context.beginPath();
        context.arc(
            this.width / 2,
            this.height / 2,
            radius,
            0,
            Math.PI * 2
        );

        {%if seal_status%}
        context.fillStyle = 'rgba(100, 255, 100, 1)';
        {%else%}
        context.fillStyle = 'rgba(255, 100, 100, 1)';
        {%endif%}
        context.strokeStyle = 'white';
        context.lineWidth = 2 + 4 * (1 - t);
        context.fill();
        context.stroke();

        // update this image's data with data from the canvas
        this.data = context.getImageData(
            0,
            0,
            this.width,
            this.height
        ).data;

        // continuously repaint the map, resulting in the smooth animation of the dot
        map.triggerRepaint();

        // return `true` to let the map know that the image was updated
        return true;
    }
};

map.on('load', function() {
    map.addImage('pulsing-dot', pulsingDot, { pixelRatio: 2 });
    map.addLayer({
        'id': 'lines',
        'type': 'line',
        'source': {
            'type': 'geojson',
            'data': {
                'type': 'FeatureCollection',
                'features': [{
                        'type': 'Feature',
                        'properties': {
                            'color': '#00ff00' // green
                        },
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': {{ list_of_green }}
                        }
                    },
                    {
                        'type': 'Feature',
                        'properties': {
                            'color': '#F7455D' // red
                        },
                        'geometry': {
                            'type': 'LineString',
                            'coordinates': {{ list_of_red }}
                        }
                    }
                ]
            }
        },
        'paint': {
            'line-width': 3,
            'line-color': ['get', 'color'],
        }
    });
    map.addLayer({
        'id': 'points',
        'type': 'symbol',
        'source': {
            'type': 'geojson',
            'data': {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'geometry': {
                        'type': 'Point',
                        'coordinates':  {{ first_point }}
                    }
                }]
            }
        },
        'layout': {
            'icon-image': 'pulsing-dot'
        }
    });

    map.loadImage(
        'https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Cat_silhouette.svg/400px-Cat_silhouette.svg.png',
        function(error, image) {
            if (error) throw error;
            map.addImage('cat', image);
            map.addLayer({
                'id': 'points',
                'type': 'symbol',
                'source': {
                'type': 'geojson',
                'data': {
                'type': 'FeatureCollection',
                'features': [
                    {
                        'type': 'Feature',
                        'geometry': {
                        'type': 'Point',
                        'coordinates': {{first_point}}
                    }
                    }
                    ]
                    }
                    },
                    'layout': {
                    'icon-image': 'cat',
                    'icon-size': 0.25
                }
            });
        }
    );
});
</script>